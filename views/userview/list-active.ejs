<!DOCTYPE html>
<html>
<head>
  <title>All User List</title>

</head>
<body>
<%- include('../partials/header') %>
<section class="sectionmin">

  <h1 class="mainheading">
    Active <span style="text-transform: capitalize;"><%= role %></span> List
  </h1>
  <p class="maintext">
   Total Records:  <%= countrecord %>
  </p>
  <% if (error) { %>
      <h6 class="mainError"><%= error %></h6>
  <% }   %>

<section style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin: 10px 0 20px 0;">
  <div class="logscontrol" style="justify-content: flex-start; column-gap: 20px;">
    <form method="GET">
      <label for="usertype">User Type</label>
      <select id="usertype" onchange="changeUserType()">
        <option value="active" selected>Active</option>
        <option value="deactive">Deactive </option>
      </select>
    </form>
    <form method="GET">
      <label for="userrole">Select Role</label>
      <select id="userrole" name="role"  onchange="changeUserRoll()">
        <option value="user" <%= role === 'user' || !role ? 'selected' : '' %>>User</option>
        <% if(user.role === 'superadmin') { %> 
          <option value="admin" <%= role === 'admin' ? 'selected' : '' %>>Admin</option>
        <% } %>
      </select>
    </form>
  </div>
  <div class="sortcontrols" style="justify-content: flex-end">
    <% 
      const primary = sortBy === 'createdAt';
      const secondary = sortBy === 'fullname'; 
    %>
    <p>
      <b>Sort : &nbsp;</b>
      <a href="?role=<%= role %>&page=1&sortBy=fullname&order=<%= secondary && order === 1 ? 'desc' : 'asc' %>" class="<%= secondary ? 'active' : '' %>">
      By Name <%= secondary ? (order === 1 ? '▲' : '▼') : ' ' %>
      </a>
      &nbsp; 
      <a href="?role=<%= role %>&page=1&sortBy=createdAt&order=<%= primary && order === 1 ? 'desc' : 'asc' %>" class="<%= primary ? 'active' : '' %>">
        Created By <%= primary ? (order === 1 ? '▲' : '▼') : ' ' %>
      </a>
      &nbsp; 
    </p>
  </div>
</section>

<% if(countrecord == '0') {  %>
  <h2 class="notfoundmsg">
    No Record Found
  </h2>
<% } else {  %>
  <div>
    <% result.forEach((res) => { %>
        <div class="record_list enabled" >
            <% if (res.profilepicture && res.profilepicture.url) { %>
                <img src="<%= res.profilepicture.url %>" alt="Profile Photo" />
            <% } %>
            <p>
                <strong>Full Name:</strong> <%= res.fullname %> || <strong>Role:</strong> <%= res.role %><br> 
                <strong>Mobile:</strong> <%= res.mobile %> || <strong>Email:</strong> <%= res.email %><br>
                <strong>Created At:</strong> <%= new Date(res.createdAt).toLocaleString() %><br>
                <% 
                const createdDate = new Date(res.createdAt);
                const updatedDate = new Date(res.updatedAt);
                if (createdDate.getTime() < updatedDate.getTime()) { %>
                  <strong>Updated At:</strong> <%= new Date(res.updatedAt).toLocaleString() %><br>
                <% } %>
            </p>
            <aside>
                <a href="/users/detail/<%= res.id %>?role=<%= role %>&page=<%= currentPage || 1 %>&sortBy=<%= sortBy || 'createdAt' %>&order=<%= order === 1 ? 'asc' : 'desc' %>" class="btn">View </a>  
                <a href="/users/update/<%= res.id %>?role=<%= role %>&page=<%= currentPage || 1 %>&sortBy=<%= sortBy || 'createdAt' %>&order=<%= order === 1 ? 'asc' : 'desc' %>" class="btn">Update </a>  
                <a href="/users/disabled/<%= res.id %>?role=<%= role %>&page=<%= currentPage || 1 %>&sortBy=<%= sortBy || 'createdAt' %>&order=<%= order === 1 ? 'asc' : 'desc' %>" class="btn btn-disabled" onclick="return confirm('Are you sure you want to disabled this ?')">Disabled</a>   
            </aside>
        </div>
    <% }) %>
  </div>
 <% } %>
    
 <% if (totalPages > 1) { %>
<div class="pagingcontrols">
  <% if (currentPage > 1) { %>
    <a href="?role=<%= role %>&page=<%= currentPage - 1 %>&sortBy=<%= sortBy %>&order=<%= order === 1 ? 'asc' : 'desc' %>">Previous</a>
  <% } %>

  <% for (let i = 1; i <= totalPages; i++) { %>
    <% if (i === currentPage) { %>
      <b><%= i %></b>
    <% } else { %>
      <a href="?role=<%= role %>&page=<%= i %>&sortBy=<%= sortBy %>&order=<%= order === 1 ? 'asc' : 'desc' %>"><%= i %></a>
    <% } %>
  <% } %>

  <% if (currentPage < totalPages) { %>
    <a href="?role=<%= role %>&page=<%= currentPage + 1 %>&sortBy=<%= sortBy %>&order=<%= order === 1 ? 'asc' : 'desc' %>">Next</a>
  <% } %>
</div>
 <% } %>


 
</section>
<%- include('../partials/footer', { title: 'EMP Management System' }) %>


<script>
   function changeUserType() {
    const role = "<%= role %>"; 
    window.location.href = `/users/deactive?role=${role}`;
  }
  function changeUserRoll() {
    const select = document.getElementById('userrole');
    const useruserrole = select.value;
    window.location.href = `?role=${useruserrole}`;
  }
</script>
</body>
</html>
